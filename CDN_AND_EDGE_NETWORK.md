# CDN과 Edge Network의 실제 동작

## 🔍 사용자의 이해 vs 실제 동작

### **사용자의 이해:**
```
CDN → 요청 거부?
  ↓
아니면 HTTP 프로토콜에서 처리?
```

### **실제는 더 복잡합니다!**

---

## 🌐 Vercel의 실제 아키텍처

### **요청 처리 흐름:**

```
[클라이언트] 요청 전송
    ↓
┌─────────────────────────────────────────────────┐
│ Vercel Edge Network                             │
│                                                 │
│  ┌──────────────────────────────────────────┐  │
│  │ 1. 요청 분류                             │  │
│  │    - 정적 파일? (/static/, /_next/...)   │  │
│  │    - API 요청? (/api/...)                │  │
│  │    - 페이지 요청? (/home, /about...)     │  │
│  └──────────────────────────────────────────┘  │
│            ↓                                    │
│  ┌──────────────────────────────────────────┐  │
│  │ 2-A. 정적 파일 경로                      │  │
│  │     └─> CDN 캐시 확인                    │  │  ← CDN 역할
│  │         ├─ 캐시 있음 → 즉시 반환          │  │
│  │         └─ 캐시 없음 → 원본 서버에서 가져옴 │  │
│  └──────────────────────────────────────────┘  │
│            ↓                                    │
│  ┌──────────────────────────────────────────┐  │
│  │ 2-B. API 요청 경로 (/api/...)            │  │
│  │     └─> CDN 캐싱 안 함 (동적 콘텐츠)      │  │  ← 프록시/라우터 역할
│  │         ├─ Body 크기 체크 (4.5MB)        │  │
│  │         ├─ Rate limiting                 │  │
│  │         └─ 원본 서버로 전달                │  │
│  └──────────────────────────────────────────┘  │
│            ↓                                    │
│  ┌──────────────────────────────────────────┐  │
│  │ 3. 원본 서버 (Next.js)                   │  │
│  │    - API Route 실행                      │  │
│  │    - HTTP 프로토콜 해석                   │  │
│  │    - 애플리케이션 로직                    │  │
│  └──────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

---

## 📊 요청 유형별 처리

### **1. 정적 파일 요청 (CDN 캐싱됨)**

```
GET /_next/static/css/app.css

[Edge Network]
  ├─ CDN 캐시 확인
  │   └─ 있음? → 즉시 반환 (캐시 히트) ✅
  │   └─ 없음? → 원본 서버에서 가져와 캐시 후 반환
  │
  └─ Body 크기 체크 안 함 (이미 캐시된 파일이므로)
```

**특징:**
- ✅ CDN에서 캐시 제공
- ✅ 크기 제한 없음 (이미 검증된 정적 파일)
- ✅ 빠른 응답

---

### **2. API 요청 (CDN 캐싱 안 함, 프록시 역할)**

```
POST /api/upload
Body: 5GB 파일

[Edge Network]
  ├─ 정적 파일 아님 → CDN 캐시 스킵
  ├─ 동적 콘텐츠 → 원본 서버로 전달해야 함
  │
  ├─ 프록시/라우터 역할:
  │   ├─ Body 크기 체크 (4.5MB)  ← 여기서 체크!
  │   ├─ Rate limiting
  │   └─ DDoS 방어
  │
  └─ 4.5MB 초과 → 413 에러 (CDN이 아니라 프록시가 거부)
```

**특징:**
- ❌ CDN 캐싱 안 함 (동적 콘텐츠)
- ✅ 프록시/라우터 역할
- ✅ Body 크기 제한 적용

---

### **3. 페이지 요청 (SSR/ISR)**

```
GET /home

[Edge Network]
  ├─ CDN 캐시 확인 (ISR인 경우)
  │   └─ 있음? → 즉시 반환
  │   └─ 없음? → SSR 실행
  │
  └─ Body 크기 체크 안 함 (GET 요청이므로)
```

---

## 🎯 핵심 개념 정정

### **잘못된 이해:**
```
"CDN에서 요청을 거부"
```

### **올바른 이해:**
```
"Edge Network의 프록시/라우터 기능에서 요청을 거부"

Edge Network = CDN 기능 + 프록시 기능 + 라우터 기능
```

---

## 📋 Edge Network의 3가지 역할

### **1. CDN 역할 (정적 파일)**
```
GET /_next/static/...

→ CDN 캐시 확인
→ 있으면 캐시에서 반환
→ 없으면 원본 서버에서 가져옴
```

### **2. 프록시 역할 (API 요청)**
```
POST /api/upload

→ CDN 캐싱 안 함 (동적이므로)
→ 프록시로 동작:
  - Body 크기 체크 (4.5MB)
  - 인증/인가 체크 (선택)
  - Rate limiting
  - 원본 서버로 전달
```

### **3. 라우터 역할 (모든 요청)**
```
모든 요청

→ 요청 경로 분석
→ 정적 파일? → CDN 경로
→ API 요청? → 프록시 경로
→ 페이지 요청? → SSR/ISR 경로
```

---

## 🔬 실제 코드 흐름

### **API 요청 처리:**

```
[클라이언트]
POST /api/upload
Body: 5GB

    ↓
┌─────────────────────────────────────┐
│ Vercel Edge Network                 │
│                                     │
│ 1. 요청 분석:                        │
│    - 경로: /api/upload              │
│    - 정적 파일 아님                 │
│    - CDN 캐시 확인 안 함            │  ← CDN 역할 아님
│                                     │
│ 2. 프록시 기능:                      │
│    - Body 크기 체크: 5GB > 4.5MB   │  ← 여기서 거부!
│    - 413 Request Entity Too Large   │
│                                     │
│ 3. 원본 서버로 전달 안 함            │  ← 여기까지 도달 안 됨
└─────────────────────────────────────┘

[Next.js API Route]  ← 여기까지 도달 불가능
export async function POST(request: Request) {
  // 실행 안 됨
}
```

---

## 💡 정확한 이해

### **Edge Network의 실제 구조:**

```
┌─────────────────────────────────────────────┐
│ Vercel Edge Network                        │
│                                             │
│  ┌──────────────┐  ┌──────────────────┐   │
│  │  CDN Layer   │  │  Proxy Layer     │   │
│  │              │  │                  │   │
│  │ - 정적 파일  │  │ - API 요청       │   │
│  │ - 캐싱       │  │ - Body 체크      │   │
│  │ - 크기 제한❌ │  │ - 크기 제한 ✅   │   │
│  └──────────────┘  └──────────────────┘   │
│                                             │
│  ┌──────────────────────────────────┐      │
│  │  Router Layer                    │      │
│  │  - 요청 분류                     │      │
│  │  - 적절한 레이어로 라우팅         │      │
│  └──────────────────────────────────┘      │
└─────────────────────────────────────────────┘
```

---

## 🔑 핵심 정리

### **CDN vs 프록시:**

| 기능 | CDN (정적 파일) | 프록시 (API 요청) |
|------|----------------|------------------|
| **대상** | 정적 파일 | 동적 요청 |
| **캐싱** | ✅ 함 | ❌ 안 함 |
| **Body 크기 체크** | ❌ 안 함 | ✅ 함 (4.5MB) |
| **예시** | `/_next/static/...` | `/api/upload` |

### **API 요청 처리:**

```
API 요청 → 프록시 레이어 → Body 체크 → 원본 서버
           (CDN 아님!)   (여기서 거부)
```

---

## ✅ 사용자 이해 정정

### **잘못된 부분:**
1. ❌ "CDN에서 요청을 거부"
   - → CDN은 정적 파일만 처리
   - → API 요청은 CDN을 거치지 않음

2. ❌ "CDN 아니면 HTTP 프로토콜에서 처리"
   - → 더 정확히는 "프록시 레이어"에서 체크

### **올바른 이해:**
1. ✅ **정적 파일**: CDN 레이어에서 처리 (캐싱, 크기 제한 없음)
2. ✅ **API 요청**: 프록시 레이어에서 처리 (Body 크기 체크, 4.5MB 제한)
3. ✅ **페이지 요청**: 라우터가 적절한 레이어로 분배

---

## 🎓 최종 정리

### **Edge Network = 다중 역할:**

```
Edge Network
├─ CDN 기능 (정적 파일)
│   └─ 캐싱, 크기 제한 없음
│
├─ 프록시 기능 (API 요청)
│   └─ Body 크기 체크 (4.5MB)
│   └─ 여기서 거부됨!
│
└─ 라우터 기능 (모든 요청)
    └─ 적절한 레이어로 분배
```

### **API 요청 흐름:**

```
클라이언트
  ↓
Edge Network (프록시 레이어)
  ├─ CDN 체크 안 함 (동적이므로)
  ├─ Body 크기 체크 ✅
  ├─ 4.5MB 초과 → 413 에러 (여기서 거부!)
  └─ 원본 서버로 전달 안 됨
```

**결론:** CDN이 아니라 **프록시 레이어**에서 거부됩니다!






