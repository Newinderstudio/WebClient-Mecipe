*μ»¤μ„AIκ°€ μ‘μ„±ν• md μ°Έκ³ μ©*

# μ²­ν¬ μ—…λ΅λ“ λ°©μ‹ κ°€μ΄λ“ (Chunked Upload)

## π“ λ¬Έμ  μƒν™©
- Vercelμ nginx/edge networkλ” HTTP body sizeλ¥Ό 4.5MBλ΅ μ ν•
- Next.js API Routeμ™€ Server Actions λ¨λ‘ μ΄ μ ν•μ„ λ°›μ
- λ€μ©λ‰ νμΌ(5GB+) μ—…λ΅λ“ λ¶κ°€λ¥
- μ•”νΈν™” ν‚¤λ” λ³΄μ•μƒ μ„λ²„μ—λ§ μμ–΄μ•Ό ν•¨

## β… ν•΄κ²° λ°©λ²•: μ²­ν¬ μ—…λ΅λ“ (Chunked Upload)

### **3λ‹¨κ³„ ν”„λ΅μ„Έμ¤**

```
1λ‹¨κ³„: μ—…λ΅λ“ μ„Έμ… μ΄κΈ°ν™”
       β†“ (sessionId λ°κΈ‰)
2λ‹¨κ³„: νμΌμ„ 4MB μ²­ν¬λ΅ λ¶„ν• ν•μ—¬ μμ°¨ μ—…λ΅λ“
       β†“ (κ° μ²­ν¬λ” 4.5MB μ ν• μ΄ν•)
3λ‹¨κ³„: μ„λ²„μ—μ„ μ²­ν¬ μ΅°λ¦½ β†’ μ•”νΈν™” β†’ Vercel Blob μ—…λ΅λ“
       β†“
       μ™„λ£!
```

---

## π—οΈ μ•„ν‚¤ν…μ²

### **νμΌ κµ¬μ΅°**

```
src/
β”β”€β”€ app/api/meta-viewer/upload/
β”‚   β”β”€β”€ init/route.tsx           # 1λ‹¨κ³„: μ„Έμ… μ΄κΈ°ν™”
β”‚   β”β”€β”€ chunk/route.tsx          # 2λ‹¨κ³„: μ²­ν¬ μ—…λ΅λ“
β”‚   β””β”€β”€ complete/route.tsx       # 3λ‹¨κ³„: μ΅°λ¦½ & μ•”νΈν™”
β”β”€β”€ util/
β”‚   β”β”€β”€ uploadChunkedFile.ts     # μ²­ν¬ μ—…λ΅λ“ λ΅μ§
β”‚   β””β”€β”€ fetchMetaViewerMap.ts    # ν†µν•© ν•¨μ
β””β”€β”€ admin/metaViewerInfos/components/
    β””β”€β”€ MapFileUploadComponent.tsx # UI (μ§„ν–‰λ¥  ν‘μ‹)
```

---

## π”„ λ™μ‘ ν”λ΅μ° μƒμ„Έ

### **1λ‹¨κ³„: μ„Έμ… μ΄κΈ°ν™”**

```typescript
// POST /api/meta-viewer/upload/init
{
  filename: "map.glb",
  totalSize: 5368709120, // 5GB
  totalChunks: 1280,     // 4MB * 1280 = 5GB
  mapType: "render",
  prefix: "metaviewer",
  nickname: "cafe-001"
}

// Response:
{
  sessionId: "uuid-xxx-xxx"
}
```

**μ„λ²„ λ™μ‘:**
- μ„Έμ… ID μƒμ„±
- λ©”λ¨λ¦¬μ— μ„Έμ… μ •λ³΄ μ €μ¥
- μ²­ν¬ μ €μ¥μ† μ΄κΈ°ν™”

---

### **2λ‹¨κ³„: μ²­ν¬ μ—…λ΅λ“ (λ°λ³µ)**

```typescript
// POST /api/meta-viewer/upload/chunk
FormData {
  sessionId: "uuid-xxx-xxx",
  chunkIndex: 0,      // 0λ¶€ν„° totalChunks-1κΉμ§€
  chunk: Blob (4MB)   // 4.5MB μ ν• μ΄ν•
}

// Response:
{
  sessionId: "uuid-xxx-xxx",
  chunkIndex: 0,
  uploadedChunks: 1,
  totalChunks: 1280,
  progress: 0  // 0~100%
}
```

**νΉμ§•:**
- β… κ° μ²­ν¬λ” 4MB (4.5MB μ ν•λ³΄λ‹¤ μ‘μ)
- β… μμ°¨μ μΌλ΅ μ—…λ΅λ“ (λ³‘λ ¬λ„ κ°€λ¥ν•μ§€λ§ μ„λ²„ λ©”λ¨λ¦¬ κ³ λ ¤)
- β… μ§„ν–‰λ¥  μ‹¤μ‹κ°„ μ—…λ°μ΄νΈ
- β… μ‹¤ν¨ν• μ²­ν¬λ§ μ¬μ‹λ„ κ°€λ¥ (κµ¬ν„ ν•„μ” μ‹)

---

### **3λ‹¨κ³„: μ™„λ£ λ° μ•”νΈν™”**

```typescript
// POST /api/meta-viewer/upload/complete
{
  sessionId: "uuid-xxx-xxx"
}

// Response:
{
  url: "https://blob.vercel-storage.com/.../map.glb.enc",
  size: 5400000000,    // μ•”νΈν™”λ νμΌ ν¬κΈ°
  originalSize: 5368709120
}
```

**μ„λ²„ λ™μ‘:**
1. β… λ¨λ“  μ²­ν¬ μ—…λ΅λ“ ν™•μΈ
2. β… μ²­ν¬λ¥Ό μμ„λ€λ΅ μ΅°λ¦½
3. β… νμΌ μ•”νΈν™” (μ„λ²„μ—μ„λ§, ν‚¤ μ•μ „)
4. β… Vercel Blob μ—…λ΅λ“
5. β… μ„Έμ… μ‚­μ  (λ©”λ¨λ¦¬ μ •λ¦¬)

---

## π’» μ‚¬μ©λ²•

### **ν”„λ΅ νΈμ—”λ“ (λ™μΌν• μΈν„°νμ΄μ¤)**

```typescript
import { uploadMetaViewerMapFile } from '@/util/fetchMetaViewerMap';

const result = await uploadMetaViewerMapFile(
  token,
  file,               // 10GBλ„ κ°€λ¥!
  'render',
  'metaviewer',
  'cafe-001',
  (progress, stage) => {
    console.log(`${progress}% - ${stage}`);
    // μ: "45% - μ—…λ΅λ“ μ¤‘... (576/1280)"
    //     "100% - νμΌ μ•”νΈν™” λ° μ €μ¥ μ¤‘..."
  }
);

console.log('μ™„λ£:', result.url);
```

---

## π¨ UI μ»΄ν¬λ„νΈ (μ§„ν–‰λ¥  ν‘μ‹)

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚      β³        β”‚  β† μ•„μ΄μ½
β”‚ μ—…λ΅λ“ μ¤‘...    β”‚  β† λ‹¨κ³„ λ©”μ‹μ§€
β”‚     45%        β”‚  β† μ§„ν–‰λ¥ 
β”‚ β–“β–“β–“β–“β–“β–“β–‘β–‘β–‘β–‘     β”‚  β† ν”„λ΅κ·Έλ μ¤ λ°” (λ°°κ²½)
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

**μ§„ν–‰ λ‹¨κ³„:**
1. "μ—…λ΅λ“ μ¤€λΉ„ μ¤‘..." (0%)
2. "μ—…λ΅λ“ μ¤‘... (N/M)" (1~99%)
3. "νμΌ μ•”νΈν™” λ° μ €μ¥ μ¤‘..." (100%)

---

## π”’ λ³΄μ•

### **μ•”νΈν™” ν‚¤ κ΄€λ¦¬**

```env
# .env.local (μ„λ²„μ—λ§ μ΅΄μ¬)
GLB_ENCRYPTION_KEY=your-secret-key-here
BLOB_READ_WRITE_TOKEN=vercel_blob_rw_xxx
```

**λ³΄μ• μ²΄κ³„:**
1. β… μ²­ν¬λ” ν‰λ¬ΈμΌλ΅ μ—…λ΅λ“ (λ©”λ¨λ¦¬μ—λ§ μ΅΄μ¬, λ””μ¤ν¬ λ―Έμ €μ¥)
2. β… μ„λ²„ λ©”λ¨λ¦¬μ—μ„ μ΅°λ¦½
3. β… μ•”νΈν™” (ν‚¤λ” μ„λ²„μ—λ§ μμ)
4. β… Vercel Blobμ— μ•”νΈν™”λ νμΌλ§ μ €μ¥
5. β… μ„Έμ… μλ™ μ‚­μ  (30λ¶„ νƒ€μ„μ•„μ›ƒ)

---

## π“ μ„±λ¥ λΉ„κµ

| ν•­λ© | κΈ°μ΅΄ (API Route) | μ²­ν¬ μ—…λ΅λ“ |
|------|------------------|-------------|
| μµλ€ νμΌ ν¬κΈ° | 4.5MB β | **λ¬΄μ ν•** β… |
| μ—…λ΅λ“ μ‹¤ν¨ μ‹ | μ „μ²΄ μ¬μ—…λ΅λ“ | **μ²­ν¬ λ‹¨μ„ μ¬μ‹λ„** β… |
| μ§„ν–‰λ¥  ν‘μ‹ | λ¶κ°€λ¥ | **μ‹¤μ‹κ°„** β… |
| λ„¤νΈμ›ν¬ λ‹¨μ  | μ²μλ¶€ν„° | **μ΄μ–΄μ„ κ°€λ¥** β… |
| λ©”λ¨λ¦¬ μ‚¬μ© | λ‚®μ | **μ¤‘κ°„** (μ²­ν¬ μ €μ¥) |

---

## β οΈ μ£Όμμ‚¬ν•­

### **1. λ©”λ¨λ¦¬ μ ν•**

**Vercel μ„λ²„λ¦¬μ¤ ν•¨μ:**
- Free: 1024 MB
- Pro: 3008 MB

**λ€μ©λ‰ νμΌ μ²λ¦¬ μ‹:**
- 10GB νμΌ = λ©”λ¨λ¦¬ μ•½ 10GB ν•„μ” (μ΅°λ¦½ μ‹)
- π’΅ **ν•΄κ²°μ±…:** μ²­ν¬λ¥Ό μ΅°λ¦½ν•λ©΄μ„ μ¤νΈλ¦¬λ°μΌλ΅ μ•”νΈν™” (μ¶”κ°€ κµ¬ν„ ν•„μ”)
- λλ” λ””μ¤ν¬ μ„μ‹ μ €μ¥ (`/tmp` - 512MB μ ν•)

### **2. μ„Έμ… νƒ€μ„μ•„μ›ƒ**

- κΈ°λ³Έ: 30λ¶„
- μ—…λ΅λ“ μ¤‘ 30λ¶„ μ΄κ³Ό μ‹ μ„Έμ… μ‚­μ λ¨
- π’΅ **ν•΄κ²°μ±…:** ν° νμΌμ€ μ„Έμ… νƒ€μ„μ•„μ›ƒ μ—°μ¥ λλ” μ²­ν¬ ν¬κΈ° μ¦κ°€

### **3. Vercel μ‹¤ν–‰ μ‹κ°„ μ ν•**

```
Free: 10μ΄    β† μ‘μ€ νμΌλ§
Pro: 300μ΄   β† ~5GB κ°€λ¥
Enterprise: 900μ΄ β† ~10GB κ°€λ¥
```

**μ•”νΈν™” μ‹κ°„ μμƒ:**
- 1GB: ~30μ΄
- 5GB: ~2.5λ¶„ (Pro ν”λ ν•„μ”)
- 10GB: ~5λ¶„ (Enterprise ν•„μ”)

---

## π”§ νΈλ¬λΈ”μν…

### **"Session not found"**
β†’ 30λ¶„ νƒ€μ„μ•„μ›ƒ μ΄κ³Ό, μ²μλ¶€ν„° μ¬μ—…λ΅λ“

### **"Missing chunks"**
β†’ μΌλ¶€ μ²­ν¬ μ—…λ΅λ“ μ‹¤ν¨, ν•΄λ‹Ή μ²­ν¬ μ¬μ „μ†΅

### **"Failed to complete upload: timeout"**
β†’ Vercel ν”λ μ—…κ·Έλ μ΄λ“ ν•„μ” (Pro μ΄μƒ)

### **λ©”λ¨λ¦¬ λ¶€μ΅± (OOM)**
β†’ νμΌμ΄ λ„λ¬΄ νΌ, μ¤νΈλ¦¬λ° μ•”νΈν™” κµ¬ν„ ν•„μ”

---

## π€ λ°°ν¬ μ²΄ν¬λ¦¬μ¤νΈ

- [ ] ν™κ²½λ³€μ μ„¤μ • (`GLB_ENCRYPTION_KEY`, `BLOB_READ_WRITE_TOKEN`)
- [ ] Vercel Pro ν”λ μ΄μƒ (λ€μ©λ‰ νμΌμ©)
- [ ] λ©”λ¨λ¦¬ μ ν• ν™•μΈ (νμΌ ν¬κΈ° < 3GB κ¶μ¥)
- [ ] λ΅μ»¬ ν…μ¤νΈ μ™„λ£
- [ ] μ„Έμ… νƒ€μ„μ•„μ›ƒ μ„¤μ • ν™•μΈ
- [ ] μ—λ¬ ν•Έλ“¤λ§ ν…μ¤νΈ

---

## π”„ κ°μ„  κ°€λ¥ν• λ¶€λ¶„

### **1. λ³‘λ ¬ μ²­ν¬ μ—…λ΅λ“**
ν„μ¬λ” μμ°¨μ , λ³‘λ ¬λ΅ λ³€κ²½ν•λ©΄ μ†λ„ ν–¥μƒ
```typescript
// μ: 5κ°μ”© λ³‘λ ¬ μ—…λ΅λ“
const PARALLEL_CHUNKS = 5;
```

### **2. μ²­ν¬ μ¬μ‹λ„ λ΅μ§**
μ‹¤ν¨ν• μ²­ν¬λ§ μ¬μ „μ†΅
```typescript
if (chunkResponse.ok) {
  uploadedChunks.add(chunkIndex);
} else {
  retryQueue.push(chunkIndex);
}
```

### **3. μ¤νΈλ¦¬λ° μ•”νΈν™”**
λ©”λ¨λ¦¬μ— μ „μ²΄ νμΌ λ΅λ“ν•μ§€ μ•κ³  μ¤νΈλ¦¬λ° μ²λ¦¬
```typescript
// μ΅°λ¦½ν•λ©΄μ„ λ™μ‹μ— μ•”νΈν™”
const encryptStream = createEncryptStream();
for (const chunk of chunks) {
  encryptStream.write(chunk);
}
```

### **4. λ””μ¤ν¬ μ„μ‹ μ €μ¥**
λ©”λ¨λ¦¬ λ€μ‹  `/tmp` λ””λ ‰ν† λ¦¬ μ‚¬μ© (512MB μ ν•)
```typescript
fs.writeFileSync(`/tmp/${sessionId}-${chunkIndex}`, chunk);
```

---

## π“ μ°Έκ³  μλ£

- [Vercel Serverless Functions](https://vercel.com/docs/functions/serverless-functions)
- [Vercel Blob Storage](https://vercel.com/docs/storage/vercel-blob)
- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- [File Chunking Best Practices](https://developer.mozilla.org/en-US/docs/Web/API/File/slice)

---

## π’΅ κ²°λ΅ 

**μ²­ν¬ μ—…λ΅λ“ λ°©μ‹μ ν•µμ‹¬:**
1. β… νμΌμ„ μ‘μ€ μ΅°κ°μΌλ΅ λ‚λ„μ–΄ μ „μ†΅ (4.5MB μ ν• μ°ν)
2. β… μ„λ²„ λ©”λ¨λ¦¬μ—μ„ μ΅°λ¦½ ν›„ μ•”νΈν™” (ν‚¤ μ•μ „)
3. β… μ§„ν–‰λ¥  μ‹¤μ‹κ°„ ν‘μ‹ (UX ν–¥μƒ)
4. β… μ‹¤ν¨ μ‹ μ²­ν¬ λ‹¨μ„ μ¬μ‹λ„ κ°€λ¥

**μ ν•©ν• κ²½μ°:**
- νμΌ ν¬κΈ°: 5MB ~ 3GB (Vercel Pro ν”λ κΈ°μ¤€)
- λ„¤νΈμ›ν¬κ°€ λ¶μ•μ •ν• ν™κ²½
- μ‚¬μ©μμ—κ² μ§„ν–‰λ¥  ν‘μ‹ ν•„μ”

**λ¶€μ ν•©ν• κ²½μ°:**
- 5GB μ΄μƒ μ΄λ€μ©λ‰ (λ©”λ¨λ¦¬ λ¶€μ΅±)
- μ‹¤μ‹κ°„ μ¤νΈλ¦¬λ° ν•„μ” (μ²­ν¬ μ΅°λ¦½ ν›„ μ²λ¦¬λ” λλ¦Ό)
- Vercel Free ν”λ (μ‹¤ν–‰ μ‹κ°„ 10μ΄ μ ν•)

